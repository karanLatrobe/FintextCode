{% extends "base.html" %}
{% load static %}
{% load get_item %}

<head>
    <link rel="stylesheet" href="{% static 'enroll/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'enroll/css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
.hero-bg {
    background-image: url("{% static 'enroll/images/hero3.jpg' %}");
    background-size: contain;     /* no stretch */
    background-repeat: no-repeat;
    background-position: top center;
}
</style>
</head>

{% block content %}

<div class="min-h-[700px] w-full flex justify-center items-center pt-32 md:pt-20 p-4 md:p-10
    bg-cover bg-center bg-no-repeat bg-[url('{% static "./enroll/images/hero7.jpg" %}')]">


    
    <!-- UPLOAD CARD -->
    <div class="flex flex-col justify-center items-center gap-6 bg-white pt-10 pb-10 px-6 md:px-10
                fill-indigo-500 drop-shadow-lg drop-shadow-indigo-500/50 rounded-xl w-full max-w-[850px]">

        <div class="w-full text-gray-700 text-2xl md:text-3xl font-bold flex items-center gap-2">
            <i class="fa-solid fa-circle-down rotate-180 text-[#1C4D8D] text-4xl"></i>
            Upload here
        </div>

        <!-- Upload Form -->
        <form id="uploadForm" method="POST" enctype="multipart/form-data" class="w-full">
            {% csrf_token %}

            <div id="dropArea"
                class="border-2 border-dashed border-gray-400 rounded-xl p-6 w-full h-[220px]
                flex flex-col justify-center items-center gap-4 bg-gray-50 relative">

                <input type="file" id="fileInput" name="uploadedFile"
                       class="absolute inset-0 cursor-pointer opacity-0 z-20" accept=".csv,.pdf" />

                <div id="defaultState" class="flex flex-col items-center gap-2 z-10">
                    <i class="fa-solid fa-cloud-arrow-up text-5xl text-[#1C4D8D]"></i>
                    <p class="font-semibold text-lg">Upload CSV or PDF</p>
                    <p class="text-sm text-gray-600">Drag & drop or click to browse</p>
                </div>

                <div id="fileState" class="hidden flex flex-col items-center gap-1 z-10">
                    <p id="fileName" class="font-semibold text-gray-800"></p>
                    <p id="fileSize" class="text-sm text-gray-600"></p>
                </div>
            </div>

            <!-- Loading Bar -->
            <div id="loadingBar" class="hidden w-full mt-4">
                <div id="processingBar">
                    <div class="barFlow"></div>
                </div>
            </div>

            <div class="flex justify-end mt-5 gap-3 items-center">
                <button type="button" id="removeBtn"
                    class="hidden bg-red-600 px-5 py-2 rounded text-white font-semibold">Remove</button>

                <button type="submit" id="submitBtn"
                    class="bg-[#1C4D8D] px-8 py-2 rounded text-white font-semibold">Submit</button>
            </div>
        </form>
    </div>

    <!-- AJAX TABLE -->
    
</div>

<div class="w-full flex justify-center items-center">
    
    <!-- ‚≠ê SCROLL BOX ADDED HERE -->
    <div id="tableContainer"
         class="w-full max-w-full p-8 hidden overflow-visible">

    </div>

</div>


<!-- ERROR TOAST -->
<div id="toast-danger"
     class="hidden w-[400px] flex bg-red-100 text-red-700 px-4 py-3 rounded-xl border border-red-300
            fixed right-2 bottom-2 translate-x-full opacity-0 transition-all duration-500 z-[99999]">

    <div class="flex flex-col w-full">
        <div class="font-bold text-red-700 flex justify-between">
            Whoops! Something went wrong
            <button id="toast-danger-close" class="text-red-700 font-bold px-2">‚úï</button>
        </div>

        <p id="toast-danger-msg" class="mt-1 text-sm">
            Something went wrong.
        </p>

        <div class="mt-3 flex gap-2">
            <button id="toast-danger-try"
                class="bg-red-600 text-white px-3 py-1.5 rounded text-xs">
                Try again
            </button>

            <button id="toast-danger-close2"
                class="border border-red-600 text-red-700 px-3 py-1.5 rounded text-xs">
                Close
            </button>
        </div>
    </div>
</div>


<div id="file-success-toast"
     class="w-[400px] flex bg-green-600 text-green-100 text-[15px] px-2 py-3  
            justify-start gap-3 items-center rounded-[10px] fixed right-2 bottom-2
            translate-x-full opacity-0 transition-all duration-500 z-[99999] hidden">

    <div><i class="fa-regular fa-circle-check text-3xl"></i></div>

    <div class='w-full flex flex-col'>
        <div class='w-full font-bold flex justify-between'>
            SUCCESS
            <div><i id="toast-success-close" class="fa-solid fa-xmark cursor-pointer"></i></div>
        </div>

        <div><small id="toast-success-msg"></small></div>
    </div>

</div>


{% if messages %}
    {% for message in messages %}
        <div id="toast-box"
            class="w-[400px] flex bg-green-600 text-[15px] text-green-100 px-2 py-3  
                   justify-start gap-3 items-center rounded-[10px] fixed right-2 bottom-2
                   translate-x-full opacity-0 transition-all duration-500 z-[9999]">

            <div><i class="fa-regular fa-circle-check text-3xl"></i></div>

            <div class='w-full flex flex-col'>
                <div class='w-full font-bold flex justify-between'>
                    SUCCESS
                    <div><i id="toast-close" class="fa-solid fa-xmark cursor-pointer"></i></div>
                </div>

                <div><small>{{ message }}</small></div>
            </div>

        </div>
    {% endfor %}
{% endif %}




<script>

let activeRequest = null;  // TRACK ACTIVE FETCH

const fileInput = document.getElementById("fileInput");
const defaultState = document.getElementById("defaultState");
const fileState = document.getElementById("fileState");
const fileName = document.getElementById("fileName");
const fileSize = document.getElementById("fileSize");
const removeBtn = document.getElementById("removeBtn");
const submitBtn = document.getElementById("submitBtn");
const loadingBar = document.getElementById("loadingBar");




function showBackendErrorToast(message) {
    const toast = document.getElementById("toast-danger");
    const msgBox = document.getElementById("toast-danger-msg");

    msgBox.innerText = message;

    toast.classList.remove("hidden");

    setTimeout(() => {
        toast.classList.remove("translate-x-full", "opacity-0");
    }, 20);

    // close buttons
    document.getElementById("toast-danger-close").onclick =
    document.getElementById("toast-danger-close2").onclick = () => {
        toast.classList.add("translate-x-full", "opacity-0");
        setTimeout(() => toast.classList.add("hidden"), 500);
    };

    // Try again ‚Üí reset uploader
    document.getElementById("toast-danger-try").onclick = () => {
    toast.classList.add("translate-x-full", "opacity-0");
    setTimeout(() => toast.classList.add("hidden"), 500);

    fileInput.value = null;
    fileState.classList.add("hidden");
    defaultState.classList.remove("hidden");
    removeBtn.classList.add("hidden");

    // ‚≠ê IMPORTANT FIX
    document.getElementById("dropArea").classList.remove("shrinkHeight");
};
}



function showErrorToast() {
    const toast = document.getElementById("toast-danger");
    const msgBox = document.getElementById("toast-danger-msg");

    // FIXED DEFAULT MESSAGE FOR WRONG FILE TYPE
    msgBox.innerHTML = `The file format is not supported. Please upload a valid file type 
        <span class="font-semibold">(PDF, CSV)</span>.`;

    toast.classList.remove("hidden");

    setTimeout(() => {
        toast.classList.remove("translate-x-full", "opacity-0");
    }, 20);

    // Close buttons
    document.getElementById("toast-danger-close").onclick =
    document.getElementById("toast-danger-close2").onclick = () => {
        toast.classList.add("translate-x-full", "opacity-0");
        setTimeout(() => toast.classList.add("hidden"), 500);
    };

    // Try again
    document.getElementById("toast-danger-try").onclick = () => {
    toast.classList.add("translate-x-full", "opacity-0");
    setTimeout(() => toast.classList.add("hidden"), 500);

    fileInput.value = null;
    fileState.classList.add("hidden");
    defaultState.classList.remove("hidden");
    removeBtn.classList.add("hidden");

    // ‚≠ê IMPORTANT FIX
    document.getElementById("dropArea").classList.remove("shrinkHeight");
};

}


/* VALIDATE FILE TYPE immediately when uploaded */
fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    const allowed = ["application/pdf", "text/csv"];

    if (!allowed.includes(file.type)) {

        // reset UI
        fileInput.value = null;
        fileState.classList.add("hidden");
        defaultState.classList.remove("hidden");
        removeBtn.classList.add("hidden");

        // show error toast
        showErrorToast();
        return;
    }

    // normal behaviour (your existing code continues)
});


function showFileSuccessToast(message) {
    const toast = document.getElementById("file-success-toast");
    const msgBox = document.getElementById("toast-success-msg");
    const closeBtn = document.getElementById("toast-success-close");

    msgBox.innerText = message;

    toast.classList.remove("hidden");

    // show animation
    setTimeout(() => {
        toast.classList.remove("translate-x-full", "opacity-0");
    }, 50);

    // close button
    closeBtn.onclick = () => {
        toast.classList.add("translate-x-full", "opacity-0");
    };

    // auto hide
    setTimeout(() => {
        toast.classList.add("translate-x-full", "opacity-0");
    }, 5000);
}



window.addEventListener("load", function () {
    const box = document.getElementById("toast-box");

    if (!box) return;

    // slide-in animation
    setTimeout(() => {
        box.classList.remove("translate-x-full", "opacity-0");
    }, 50);

    // close button
    document.getElementById("toast-close").onclick = () => {
        box.classList.add("translate-x-full", "opacity-0");
    };

    // auto hide after 3 sec
    setTimeout(() => {
        box.classList.add("translate-x-full", "opacity-0");
    }, 5000);
});





/* FILE SELECTED */
/* FILE SELECTED */
fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;

    // ‚≠ê Smooth animated height shrink
    document.getElementById("dropArea").classList.add("shrinkHeight");

    fileName.textContent = file.name;
    fileSize.textContent = file.size + " bytes";

    defaultState.classList.add("hidden");
    fileState.classList.remove("hidden");
    removeBtn.classList.remove("hidden");
});



/* REMOVE BUTTON FUNCTIONALITY */
/* REMOVE BUTTON FUNCTIONALITY */
removeBtn.addEventListener("click", () => {

    // ‚≠ê Restore full height with smooth animation
    document.getElementById("dropArea").classList.remove("shrinkHeight");

    if (activeRequest) {
        activeRequest.abort();
        activeRequest = null;
    }

    fileInput.value = null;
    fileState.classList.add("hidden");
    defaultState.classList.remove("hidden");
    removeBtn.classList.add("hidden");

    loadingBar.classList.add("hidden");
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit";

    // ‚≠ê‚≠ê HIDE TABLE OUTPUT ALSO
    const tableContainer = document.getElementById("tableContainer");
    tableContainer.classList.add("hidden");
    tableContainer.innerHTML = "";
});




/* SUBMIT AJAX */
document.getElementById("uploadForm").addEventListener("submit", function (e) {
    e.preventDefault();

    // FILE must exist
    if (!fileInput.files.length) {
        alert("Please select a file first.");
        return;
    }

    loadingBar.classList.remove("hidden");
    submitBtn.disabled = true;
    submitBtn.textContent = "Processing...";

    let formData = new FormData();
    formData.append("uploadedFile", fileInput.files[0]);
    formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

    // 5. Make abortable fetch
    const controller = new AbortController();
    activeRequest = controller;

    fetch("/ajax-upload/", {
    method: "POST",
    body: formData,
    signal: controller.signal,
})
.then(async (res) => {
    const contentType = res.headers.get("content-type") || "";

    if (!contentType.includes("application/json")) {
        const text = await res.text();   // HTML / login / error page
        throw new Error("Server returned non-JSON response");
    }

    return res.json();
})
    .then(data => {

        // If removed during processing ‚Üí ignore
        if (!fileInput.files.length) return;

        loadingBar.classList.add("hidden");

        if (data.error) {
        showBackendErrorToast(data.error);
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
        return;
        }

        submitBtn.textContent = "Completed";  // ‚≠ê REQUIRED UPDATE
        showFileSuccessToast(`Hi {{ request.user.username }}, Your file is extracted and categorised successfully.`);

        buildTable(data.columns, data.rows, data.file_id);
        activeRequest = null;
    })
    .catch(err => {
        if (err.name === "AbortError") {
            console.log("Request aborted by user.");
            return;
        }

        loadingBar.classList.add("hidden");
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
        alert("Something went wrong: " + err);
    });
});


/* BUILD TABLE ‚Äî UNTOUCHED */
{% comment %} function buildTable(columns, rows, excelFile) {
    const container = document.getElementById("tableContainer");

    let html = `
    <div class="flex justify-end mb-4">
        <a id="downloadBtn"
        href="/download_excel/?file=${editableFile}"
        class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-md shadow-md font-semibold">
        Download Excel
        </a>
    </div>
    <div class="p-5 bg-white shadow-3xl border-2 rounded-2xl overflow-auto">

        <h2 class="text-2xl font-bold text-gray-700 mb-4">Extracted Data</h2>


        <table class="min-w-full border-collapse border border-gray-300">
            <thead class="bg-gray-100 sticky top-0 z-20">
                <tr>
                    ${columns.map(c => `<th class='border px-4 py-4 bg-gray-100 text-sm font-semibold'>${c}</th>`).join("")}
                </tr>
            </thead>
            <tbody>
                ${rows.map(r => `
                    <tr class="hover:bg-gray-50">
                        ${columns.map(c => `<td class='border px-4 py-2'>${r[c]}</td>`).join("")}
                    </tr>
                `).join("")}
            </tbody>
        </table>
    </div>`;

    container.innerHTML = html;
    container.classList.remove("hidden");
} {% endcomment %}

function showEditableIcon(cell) {
    if (cell.querySelector(".editable-icon")) return;

    const icon = document.createElement("i");
    icon.className = `
        fa-solid fa-pen-to-square editable-icon
        absolute top-1 right-1
        text-gray-400 text-xs
        opacity-60
        pointer-events-none
    `;

    cell.classList.add("relative");
    cell.appendChild(icon);
}



function showEditedBadge(cell) {
    // remove old badge if exists
    const old = cell.querySelector(".edited-badge");
    if (old) old.remove();

    const badge = document.createElement("span");
    badge.innerText = "edited";

    badge.className = `
        edited-badge
        absolute bottom-1 right-1
        bg-yellow-200 text-yellow-900
        text-[10px] font-semibold
        px-2 py-[2px]
        rounded
        opacity-0 translate-y-1
        transition-all duration-300
    `;

    cell.classList.add("relative");
    cell.appendChild(badge);

    // trigger animation
    requestAnimationFrame(() => {
        badge.classList.remove("opacity-0", "translate-y-1");
        badge.classList.add("opacity-100", "translate-y-0");
    });

    // auto hide after 2 seconds (optional, smooth)
    setTimeout(() => {
        badge.classList.add("opacity-0");
    }, 2000);
}


function makeTableEditable(rowsData) {
    const cells = document.querySelectorAll(".editable-cell");

    cells.forEach(cell => {
        cell.addEventListener("click", function () {

            if (cell.querySelector("input")) return;
            const originalHTML = cell.innerHTML;
            let oldValue = cell.childNodes[0]?.textContent.trim() || "";
            let rowIndex = parseInt(cell.dataset.row);
            let colName = cell.dataset.column;
            
            cell.innerHTML = "";

            const wrapper = document.createElement("div");
            wrapper.className = "relative";

            const input = document.createElement("input");
            input.type = "text";
            input.value = oldValue;
            input.className =
                "w-full px-3 py-2 border border-blue-600 rounded-md outline-none focus:ring-2 focus:ring-blue-400";

            wrapper.appendChild(input);

            let dropdown = null;
            let clickingDropdown = false;   // ‚≠ê KEY FIX

            if (colName === "Account Type") {
                dropdown = document.createElement("ul");
                dropdown.className =
    "absolute z-50 mt-1 w-[200px] border-2 border-blue-400 rounded-[5px] shadow-lg max-h-56 overflow-y-auto -translate-x-[30px] hidden bg-[#FBFBFB] account-dropdown-scroll";


                ACCOUNT_CATEGORIES.forEach(cat => {
                    const li = document.createElement("li");
                    li.textContent = cat;
                    li.className =
                        "px-4 py-2 cursor-pointer hover:bg-blue-400 hover:text-white font-semibold text-gray-800 text-sm border-b border-b-blue-200";

                    // ‚≠ê USE mousedown (NOT click)
                    li.addEventListener("mousedown", e => {
                            e.preventDefault();
                            clickingDropdown = true;

                            // 1Ô∏è‚É£ set value
                            if (cat !== oldValue) {
                                rowsData[rowIndex][colName] = cat;
                                cell.innerHTML = cat;
                                showEditedBadge(cell);
                            }
                        });

                    dropdown.appendChild(li);
                });

                wrapper.appendChild(dropdown);

                input.addEventListener("focus", () => {
                    dropdown.classList.remove("hidden");
                });

                input.addEventListener("input", () => {
                    const val = input.value.toLowerCase();
                    [...dropdown.children].forEach(li => {
                        li.style.display = li.textContent.toLowerCase().includes(val)
                            ? "block"
                            : "none";
                    });
                });
            }

            cell.appendChild(wrapper);
            input.focus();

            function save() {
                const newValue = input.value.trim();

                // üîí IF NO CHANGE ‚Üí RESTORE OLD VALUE
               if (newValue === "" || newValue === oldValue) {
    // üî• RESTORE EXACT PREVIOUS STATE
    cell.innerHTML = originalHTML;
    return;
}

                // ‚úÖ ACTUAL CHANGE
                cell.innerHTML = newValue;
                rowsData[rowIndex][colName] = newValue;
                showEditedBadge(cell);
}

            input.addEventListener("blur", () => {
                if (clickingDropdown) {
                    clickingDropdown = false;
                    return; // ‚≠ê SKIP BLUR SAVE
                }
                save();
            });

            input.addEventListener("keydown", e => {
                if (e.key === "Enter") input.blur();
                if (e.key === "Escape") cell.innerHTML = originalHTML;
            });
        });
    });
}




/* ---------- Helper: download updated Excel/CSV ---------- */
function downloadUpdatedExcel(columns, rows) {
    // Convert rows to CSV, escaping commas and quotes
    function csvEscape(value) {
        if (value === null || value === undefined) return "";
        const s = String(value);
        // If value contains comma, quote or newline ‚Üí wrap in quotes and escape quotes
        if (s.includes(",") || s.includes('"') || s.includes("\n") || s.includes("\r")) {
            return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
    }

    let csv = columns.map(c => csvEscape(c)).join(",") + "\n";

    rows.forEach(row => {
        let line = columns.map(col => csvEscape(row[col])).join(",");
        csv += line + "\n";
    });

    let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    // Use timestamped filename
    const ts = new Date().toISOString().replace(/[:.]/g, "-");
    a.download = `updated_statement_${ts}.csv`;   // Excel-compatible CSV
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // revoke after short delay
    setTimeout(() => URL.revokeObjectURL(url), 1000);
}



const ACCOUNT_CATEGORIES = [
    "Subscriptions",
    "Bank Fee",
    "Filling Fee",
    "Withdrawal",
    "Printing & Stationery",
    "Income",
    "Meals & Entertainment",
    "Personal",
    "Miscellaneous Expenses",
    "MV Expenses",
    "Subcontractor"
];

/* ---------- BUILD TABLE (calls makeTableEditable which is already defined) ---------- */
function buildTable(columns, rows, file_id) {

    window.currentFileID = file_id;   // ‚úÖ REQUIRED (as before)

    const container = document.getElementById("tableContainer");

    container.innerHTML = `
        <!-- ACTION BUTTONS (LOGIC SAME AS BEFORE) -->
        <div class="flex justify-end mb-4 gap-3">

            <button id="saveUpdatedExcel"
                class="bg-[#1C4D8D] hover:bg-blue-800 text-white px-5 py-2 rounded-md shadow-md font-semibold">
                Save Changes
            </button>

            <a id="downloadBtn"
               href="/download_excel_db/?file_id=${file_id}"
               class="bg-green-600 hover:bg-green-900 text-white px-5 py-2 rounded-md shadow-md font-semibold">
                Download Excel
            </a>

        </div>

        <!-- HEADER (NO SCROLL) -->
        <table class="min-w-full border border-black table-fixed">
            <colgroup>
                <col class="w-[12%]">
                <col class="w-[45.4%]">
                <col class="w-[9.8%]">
                <col class="w-[9.9%]">
                <col class="w-[9.9%]">
            </colgroup>
            <thead class="bg-gray-200">
                <tr>
                    ${columns.map(c => `
                        <th class="border px-4 py-4 text-sm font-semibold text-left bg-[#EEEEEE]">
                            ${c}
                        </th>
                    `).join("")}
                </tr>
            </thead>
        </table>

        <!-- BODY (SCROLL ONLY HERE) -->
        <div class="max-h-[75vh] overflow-y-auto border border-t-0 border-gray-300">
            <table class="min-w-full border-collapse table-fixed">
                <colgroup>
                    <col class="w-[12%]">
                    <col class="w-[46%]">
                    <col class="w-[10%]">
                    <col class="w-[10%]">
                    <col class="w-[10%]">
                </colgroup>
                <tbody>
                    ${rows.map((row, rowIndex) =>
                        `<tr class="hover:bg-blue-50">
                            ${columns.map(col => {
    if (col === "Account Type") {
        return `
        <td class="border px-4 py-4 text-sm editable-cell text-left relative"
            data-row="${rowIndex}"
            data-column="${col}">
            
            <span class="block pr-6">${row[col]}</span>

            <i class="fa-solid fa-pen-to-square
                      absolute top-2 right-2
                      text-gray-400 text-xs
                      opacity-60
                      pointer-events-none">
            </i>
        </td>`;
    }

    return `
        <td class="border px-4 py-4 text-sm editable-cell text-left"
            data-row="${rowIndex}"
            data-column="${col}">
            ${row[col]}
        </td>`;
}).join("")}

                        </tr>`
                    ).join("")}
                </tbody>
            </table>
        </div>
    `;

    container.classList.remove("hidden");

    // ‚úÖ ORIGINAL LOGIC RESTORED
    makeTableEditable(rows);

    document.getElementById("saveUpdatedExcel").onclick =
        () => saveUpdatedExcelToDB(columns, rows, file_id);
}








function saveUpdatedExcelToDB(columns, rows, file_id) {
    fetch("/save-updated-db/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            file_id: file_id,
            rows: rows
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Saved Successfully!");
        } else {
            alert("Error: " + data.error);
        }
    });
}





</script>

{% endblock content %}
